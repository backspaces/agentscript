<!DOCTYPE html>
<html>

<head>
    <title>CountyWalker0</title>
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css">
    <link rel="stylesheet" href="./fullScreen.css">
</head>

<body>
    <div id="map"></div>

    <script type="module">
        import * as util from '../src/utils.js'
        import * as mltools from './mltools.js'

        import MapDraw from '../src/MapDraw.js'
        import Animator from '../src/Animator.js'
        import CountiesModel from '../models/CountiesModel.js'

        import maplibregl from 'https://cdn.skypack.dev/maplibre-gl'

        // If not using the default model options:
        // const counties = await fetch('../gis/data/nmcounties.json').then(resp => resp.json())
        // const world = new GeoWorld({ bbox: counties, patchesWidth: 100 })
        // const model = new CountiesModel(world)
        const model = new CountiesModel() // default: { bbox: nmcounties.json, patchesWidth: 100 }
        await model.startup()
        model.setup()

        // MapDraw has default patchesColor & div as commented out below
        const drawOptions = {
            // patchesColor: 'transparent', // default in MapDraw
            linksColor: 'gray',
            linksWidth: 4,
            turtlesSize: 6,
            turtlesColor: t =>
                view.drawOptions.turtlesMap.atIndex(t.county + 1),
        }
        const view = new MapDraw(model, {
            // div: util.createCanvas(0, 0), // default & the view will resize
            drawOptions,
        })

        // ===== Start of map & layers

        const map = new maplibregl.Map({
            container: 'map', // container id
            center: model.world.bboxCenter(), // [-105.941109, 35.68222],
            zoom: 5,
            renderWorldCopies: false,

            style: {
                "version": 8,

                // vector, raster, raster-dem, geojson, image, canvas, video
                sources: {
                    osm: {
                        type: 'raster',
                        tiles: ['https://a.tile.openstreetmap.org/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        maxzoom: 19,
                        attribution: '&copy; OpenStreetMap Contributors',
                    },
                    elevation: {
                        type: 'raster',
                        tiles: ['https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png'],
                        tileSize: 256,
                    },
                    counties: {
                        type: 'geojson',
                        data: model.world.geojson,
                    },
                    countiesBBox: {
                        type: 'geojson',
                        data: mltools.bboxFeature(model.world.bbox),
                        // data: turf.bboxPolygon(model.world.bbox),
                    },
                    model: {
                        type: 'canvas',
                        canvas: view.canvas,
                        coordinates: model.world.bboxCoords(model.world.bbox),
                    },
                },

                // background, fill, line, symbol, raster, circle, fill-extrusion, heatmap, hillshade
                layers: [
                    {
                        id: 'osm',
                        type: 'raster',
                        source: 'osm'
                    },
                    {
                        id: 'elevation',
                        type: 'raster',
                        source: 'elevation',
                        paint: { 'raster-opacity': 0.15 },
                    },
                    {
                        id: 'counties',
                        type: 'fill',
                        source: 'counties',
                        paint: { 'fill-color': 'red', 'fill-opacity': 0.2 },
                    },
                    {
                        id: 'countiesLines',
                        type: 'line',
                        source: 'counties',
                        paint: { 'line-color': 'red', 'line-width': 3 },
                    },
                    {
                        id: 'countiesBBox',
                        type: 'line',
                        source: 'countiesBBox',
                        paint: { 'line-color': 'blue' },
                    },
                    {
                        id: 'model',
                        type: 'raster',
                        source: 'model'
                    },
                ]
            },
        })
        // mltools.onLoad(map) // log msg on load event; will occur, see below for usage

        // ===== End of map & layers

        let anim
        map.on('load', () => {

            map.on('click', 'counties', function (e) {
                const props = e.features[0].properties
                const msg = props.NAME + ', pop: ' + props.population.toLocaleString()
                new maplibregl.Popup({ maxWidth: 'none' })
                    .setLngLat(e.lngLat)
                    .setHTML(msg)
                    .addTo(map);
            })

            anim = new Animator(
                () => {
                    model.step()
                    view.draw()
                },
                -1, // 500, // run this many steps, -1 for forever
                20 // 30 // 30 fps
            )

            util.toWindow({ map, anim, model, util })
        })
    </script>
</body>

</html>